rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper-Funktion: Prüft ob Benutzer eingeloggt ist
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper-Funktion: Prüft ob Benutzer der Eigentümer ist
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Benutzer: Alle authentifizierten Benutzer können lesen (für E-Mail-Suche)
    // Nur der Eigentümer kann schreiben
    // AUSNAHME: Kinder können Eltern-Dokumente aktualisieren, wenn eine gültige Einladung existiert
    match /users/{userId} {
      allow read: if isAuthenticated();
      
      // Eigentümer kann schreiben
      allow write: if isOwner(userId);
      
      // Kind kann Eltern-Dokument aktualisieren (nur children Array)
      // VEREINFACHT: Prüfe nur ob es ein Eltern-Konto ist
      // Die Sicherheit wird durch den Code gewährleistet (Einladungsprüfung in acceptParentInvite)
      allow update: if isAuthenticated() && 
                       // Prüfe ob es ein Eltern-Konto ist
                       get(/databases/$(database)/documents/users/$(userId)).data.role == 'parent' &&
                       // Nur children Array kann aktualisiert werden
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['children']);
    }
    
    // Globale Aufgaben (nur lesbar für authentifizierte Nutzer)
    match /globalTasks/{taskId} {
      allow read: if isAuthenticated();
      allow write: if false; // nur über Admin/Agent
    }

    // Admin-Einstellungen/Logs (nur lesbar für Admin/Agent außerhalb der Client-Regeln)
    match /admin/{document=**} {
      allow read, write: if false;
    }

    // User-spezifische Uploads (Elternmaterial)
    // WICHTIG: create muss explizit erlaubt sein für neue Dokumente
    match /users/{userId}/uploads/{uploadId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update, delete: if isOwner(userId);
    }

    // Kind-Tasks aus Elternmaterial
    match /users/{userId}/kids/{kidId}/tasks/{taskId} {
      allow read, write: if isOwner(userId);
    }

    // Progress-Daten können nur vom eigenen Benutzer gelesen/geschrieben werden
    match /progress/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Globale Tasks: Lesen für alle, Schreiben nur für Admins (wird serverseitig gemacht)
    match /globalTasks/{taskId} {
      allow read: if isAuthenticated();
      allow write: if false; // Nur serverseitig durch Agenten
    }
    
    // Skills (adaptive Schwierigkeit) pro Benutzer/Fach
    match /users/{userId}/skills/{subject} {
      allow read, write: if isOwner(userId);
    }
    
    // Eltern-Uploads (dupliziert entfernt - bereits oben definiert)
    
    // Kind-Einstellungen (nur für Eltern)
    match /users/{userId}/kids/{kidId}/settings/{settingId} {
      allow read: if isAuthenticated() && (
        isOwner(userId) || // Eltern können lesen
        request.auth.uid == kidId // Kind kann eigene Settings lesen
      );
      allow write: if isOwner(userId); // Nur Eltern können schreiben
    }
    
    // Eltern-generierte Tasks für Kinder
    match /users/{userId}/kids/{kidId}/tasks/{taskId} {
      allow read: if isAuthenticated() && (
        isOwner(userId) || // Eltern können lesen
        request.auth.uid == kidId // Kind kann eigene Tasks lesen
      );
      allow write: if isOwner(userId); // Nur Eltern/Agenten können schreiben
    }
    
    // Linking Codes: Eltern können Codes erstellen und lesen
    match /linkingCodes/{codeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       request.resource.data.parentId == request.auth.uid;
      allow update, delete: if isAuthenticated() && 
                               resource.data.parentId == request.auth.uid;
    }
    
    // Parent Invites: Einladungen zwischen Eltern und Kindern
    match /parentInvites/{inviteId} {
      // Lesen: Eltern können ihre eigenen Einladungen lesen, Kinder ihre eigenen
      // WICHTIG: resource.data kann null sein, wenn Dokument nicht existiert
      allow read: if isAuthenticated() && 
                     (!resource.exists || 
                      resource.data.parentId == request.auth.uid ||
                      resource.data.childId == request.auth.uid);
      
      // Erstellen: Eltern können Einladungen erstellen
      allow create: if isAuthenticated() && 
                       request.resource.data.parentId == request.auth.uid &&
                       request.resource.data.childId != null &&
                       request.resource.data.childId != '';
      
      // Aktualisieren: Eltern können ihre eigenen Einladungen aktualisieren
      allow update: if isAuthenticated() && 
                       resource.data.parentId == request.auth.uid;
      
      // Aktualisieren: Kinder können Einladungen annehmen/ablehnen
      allow update: if isAuthenticated() && 
                       resource.data.childId == request.auth.uid &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['status', 'respondedAt']);
    }
  }
}

